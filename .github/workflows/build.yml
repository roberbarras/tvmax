name: Build TVMax

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  # -----------------------------------------------------------------------------
  # ANDROID BUILD
  # -----------------------------------------------------------------------------
  build-android:
    name: Build Android APKs
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v3
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'

      - name: Get Dependencies
        run: flutter pub get

      - name: Build APKs (Split)
        run: flutter build apk --release --split-per-abi

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: android-apks
          path: build/app/outputs/flutter-apk/*.apk

  # -----------------------------------------------------------------------------
  # LINUX BUILD
  # -----------------------------------------------------------------------------
  build-linux:
    name: Build Linux AppImage
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4

      - name: Install System Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y clang cmake ninja-build pkg-config libgtk-3-dev liblzma-dev wget fuse libasound2-dev libmpv-dev mpv rpm

      - name: Download External Binaries (yt-dlp, ffmpeg)
        # We need these for the "Full" version
        run: |
          mkdir -p linux/bin
          # yt-dlp
          wget -q https://github.com/yt-dlp/yt-dlp/releases/latest/download/yt-dlp_linux -O linux/bin/yt-dlp
          chmod +x linux/bin/yt-dlp
          # ffmpeg
          wget -q https://johnvansickle.com/ffmpeg/releases/ffmpeg-release-amd64-static.tar.xz -O linux/bin/ffmpeg.tar.xz
          tar -xf linux/bin/ffmpeg.tar.xz -C linux/bin --strip-components=1 --wildcards '*/ffmpeg' '*/ffprobe'
          rm linux/bin/ffmpeg.tar.xz

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'

      - name: Enable Desktop
        run: flutter config --enable-linux-desktop

      - name: Get Dependencies
        run: flutter pub get

      - name: Build Linux Release
        run: flutter build linux --release

      - name: Package AppImage (Full & Lite)
        run: |
          cd packaging
          chmod +x create_appimage.sh
          # We need to install appimagetool in the CI runner
          wget -q https://github.com/AppImage/appimagetool/releases/download/continuous/appimagetool-x86_64.AppImage -O appimagetool-x86_64.AppImage
          chmod +x appimagetool-x86_64.AppImage
          wget -q https://github.com/AppImage/type2-runtime/releases/download/continuous/runtime-x86_64 -O runtime-x86_64
          # Run our script
          ./create_appimage.sh
          cd ..

      - name: Package DEB (Installer)
        run: |
          cd packaging
          chmod +x create_deb.sh
          ./create_deb.sh
          cd ..

      - name: Package RPM (Fedora/RedHat)
        run: |
          cd packaging
          chmod +x create_rpm.sh
          ./create_rpm.sh
          cd ..

      - name: Upload Linux Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-artifacts
          path: |
            packaging/tvmax*.AppImage
            packaging/*.deb
            packaging/*.rpm

  # -----------------------------------------------------------------------------
  # WINDOWS BUILD
  # -----------------------------------------------------------------------------
  build-windows:
    name: Build Windows Exe
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'

      - name: Enable Desktop
        run: flutter config --enable-windows-desktop

      - name: Download External Binaries (yt-dlp, ffmpeg)
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path windows\bin
          # yt-dlp
          Invoke-WebRequest -Uri https://github.com/yt-dlp/yt-dlp/releases/latest/download/yt-dlp.exe -OutFile windows\bin\yt-dlp.exe
          # ffmpeg (Essentials build from gyan.dev)
          Invoke-WebRequest -Uri https://www.gyan.dev/ffmpeg/builds/ffmpeg-release-essentials.zip -OutFile ffmpeg.zip
          Expand-Archive ffmpeg.zip -DestinationPath ffmpeg_temp
          Move-Item ffmpeg_temp\*\bin\ffmpeg.exe windows\bin\
          Move-Item ffmpeg_temp\*\bin\ffprobe.exe windows\bin\
          Remove-Item ffmpeg.zip
          Remove-Item ffmpeg_temp -Recurse

      - name: Get Dependencies
        run: flutter pub get

      - name: Build Windows Release
        run: flutter build windows --release

      - name: Setup Inno Setup
        run: choco install innosetup

      - name: Compile Installer (Setup.exe)
        run: iscc packaging/installer.iss

      - name: Upload Windows Installer
        uses: actions/upload-artifact@v4
        with:
          name: windows-installer
          path: dist/*.exe

  # -----------------------------------------------------------------------------
  # MACOS BUILD
  # -----------------------------------------------------------------------------
  build-macos:
    name: Build macOS
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'

      - name: Get Dependencies
        run: flutter pub get

      - name: Enable macOS Desktop
        run: flutter config --enable-macos-desktop

      - name: Build macOS (.app)
        run: flutter build macos --release

      - name: Zip macOS App
        run: |
          cd build/macos/Build/Products/Release
          ls -la # Debug: Show what was actually built
          zip -r tvmax-macos-unsigned.zip *.app

      - name: Upload macOS Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-unsigned-build
          path: build/macos/Build/Products/Release/tvmax-macos-unsigned.zip

  # -----------------------------------------------------------------------------
  # iOS BUILD
  # -----------------------------------------------------------------------------
  build-ios:
    name: Build iOS
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'

      - name: Get Dependencies
        run: flutter pub get

      - name: Build iOS (.app)
        # --no-codesign is valid for iOS builds
        run: flutter build ios --release --no-codesign

      - name: Zip iOS App
        run: |
          cd build/ios/iphoneos
          # It might be in iphoneos or iphonesimulator depending on sdk used.
          zip -r tvmax-ios-unsigned.zip Runner.app

      - name: Upload iOS Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ios-unsigned-build
          path: build/ios/iphoneos/tvmax-ios-unsigned.zip
